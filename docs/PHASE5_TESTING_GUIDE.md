# Phase 5: Craving 集成测试指南

## 测试概述

本指南帮助您测试 Phase 5 实现的 Craving 集成功能，包括：
- 食材匹配工具
- 商店推荐
- 添加到购物清单模态框
- CravingsScreen 集成

## 前置条件

1. ✅ 数据库迁移已完成（Phase 1）
2. ✅ 库存数据已存在（至少有一个冰箱快照）
3. ✅ 至少有一个已分析的 Craving（包含 `required_ingredients`）

## 测试步骤

### 1. 准备测试数据

#### 1.1 创建库存快照
- 打开应用，进入扫描功能
- 扫描一些食材（例如：番茄、洋葱、鸡肉）
- 确保库存中有一些食材，但不要包含所有需要的食材

#### 1.2 创建 Craving
- 进入 Cravings 页面
- 添加一个菜谱链接或手动输入菜名（例如："番茄炒蛋"）
- 等待 AI 分析完成，确保 `required_ingredients` 已填充

### 2. 测试食材匹配功能

#### 测试场景 2.1: 完全匹配
- **库存**: 有 "tomato" (2个)
- **需求**: "tomato" (1个)
- **预期**: 显示"已拥有"，不添加到购物清单

#### 测试场景 2.2: 数量不足
- **库存**: 有 "tomato" (1个)
- **需求**: "tomato" (3个)
- **预期**: 显示缺失 2 个 tomato

#### 测试场景 2.3: 完全缺失
- **库存**: 没有 "onion"
- **需求**: "onion" (2个)
- **预期**: 显示缺失 2 个 onion

#### 测试场景 2.4: 模糊匹配
- **库存**: 有 "tomatoes" (复数)
- **需求**: "tomato" (单数)
- **预期**: 应该匹配成功

### 3. 测试商店推荐功能

#### 测试场景 3.1: 有机食材
- **输入**: "organic chicken"
- **预期**: 推荐 Waitrose 或 M&S

#### 测试场景 3.2: 冷冻食品
- **输入**: "frozen peas"
- **预期**: 推荐 Iceland

#### 测试场景 3.3: 默认推荐
- **输入**: "bread"
- **预期**: 推荐 Sainsbury's

### 4. 测试添加到购物清单流程

#### 步骤 4.1: 触发添加功能
1. 进入 Cravings 页面
2. 找到一个有 `required_ingredients` 的 Craving
3. 点击 CravingCard 上的 🛒 按钮

#### 步骤 4.2: 验证模态框显示
- ✅ 模态框应该显示
- ✅ 显示 Craving 名称
- ✅ 显示"缺失食材"列表
- ✅ 显示"已拥有"列表（如果有）
- ✅ 每个缺失食材旁边有商店选择器

#### 步骤 4.3: 测试商店选择
1. 点击某个食材的商店选择器
2. 应该显示所有可用的超市选项
3. 选择一个不同的商店
4. 验证选择已更新

#### 步骤 4.4: 添加食材
1. 点击 "Add X Items" 按钮
2. 应该显示成功消息
3. 自动导航到购物清单页面
4. 验证食材已添加到购物清单
5. 验证食材的 `store_id` 正确
6. 验证食材的 `source` 为 "craving"
7. 验证食材的 `source_craving_id` 正确

### 5. 测试边界情况

#### 测试场景 5.1: 没有食材的 Craving
- **操作**: 点击一个没有 `required_ingredients` 的 Craving 的 🛒 按钮
- **预期**: 显示提示"此 Craving 还没有食材"

#### 测试场景 5.2: 所有食材都已拥有
- **操作**: 点击一个所有食材都在库存中的 Craving
- **预期**: 显示"所有食材都可用"提示，不显示模态框

#### 测试场景 5.3: 库存过期警告
- **操作**: 如果库存快照超过 3 天
- **预期**: 模态框中显示警告消息

#### 测试场景 5.4: 没有库存数据
- **操作**: 在没有库存快照的情况下点击添加
- **预期**: 所有食材都显示为缺失，可以正常添加

### 6. 测试 UI/UX

#### 检查项 6.1: CravingCard 按钮
- ✅ 🛒 按钮只在有 `required_ingredients` 时显示
- ✅ 按钮位置正确（右上角）
- ✅ 点击按钮不会触发卡片的 `onPress`

#### 检查项 6.2: 模态框样式
- ✅ 使用 glassmorphism 样式
- ✅ 响应式布局
- ✅ 滚动功能正常（当食材列表很长时）

#### 检查项 6.3: 商店选择器
- ✅ 显示当前选择的商店图标和名称
- ✅ 点击后展开选择器
- ✅ 选择后正确更新显示

### 7. 验证数据完整性

#### 检查项 7.1: 数据库字段
在 Supabase Dashboard 中检查 `shopping_items` 表：
- ✅ `store_id` 正确设置
- ✅ `source` 为 "craving"
- ✅ `source_craving_id` 正确关联到 Craving
- ✅ `quantity` 和 `unit` 正确
- ✅ `reason` 包含 Craving 名称

#### 检查项 7.2: 购物清单显示
- ✅ 添加的食材按商店正确分组
- ✅ 显示正确的商店图标
- ✅ 可以正常编辑和删除

## 常见问题排查

### 问题 1: 点击 🛒 按钮没有反应
**可能原因**:
- Craving 没有 `required_ingredients`
- 设备 ID 未加载

**解决方法**:
- 检查 Craving 是否已完成 AI 分析
- 检查控制台是否有错误

### 问题 2: 食材匹配不准确
**可能原因**:
- 食材名称差异太大
- 单位不匹配

**解决方法**:
- 检查 `ingredientMatcher.ts` 中的匹配逻辑
- 考虑改进模糊匹配算法

### 问题 3: 商店推荐不合理
**可能原因**:
- 推荐规则过于简单

**解决方法**:
- 可以改进 `storeRecommender.ts` 中的规则
- 考虑添加用户偏好学习

### 问题 4: 模态框显示异常
**可能原因**:
- 样式冲突
- React Native 版本问题

**解决方法**:
- 检查 `AddToShoppingModal.tsx` 中的样式
- 确保使用正确的 React Native 组件

## 自动化测试建议

可以创建以下测试函数：

```typescript
// testIngredientMatcher.ts
export async function testIngredientMatcher() {
  // 测试各种匹配场景
}

// testStoreRecommender.ts
export async function testStoreRecommender() {
  // 测试商店推荐逻辑
}
```

## 测试完成检查清单

- [ ] 食材匹配功能正常
- [ ] 商店推荐功能正常
- [ ] 模态框显示和交互正常
- [ ] 添加到购物清单功能正常
- [ ] 数据正确保存到数据库
- [ ] UI/UX 符合预期
- [ ] 边界情况处理正确
- [ ] 没有控制台错误

## 下一步

测试通过后，可以继续：
1. Phase 6: 在线购物 WebView 功能
2. 优化匹配算法
3. 改进商店推荐逻辑
4. 添加更多测试用例
