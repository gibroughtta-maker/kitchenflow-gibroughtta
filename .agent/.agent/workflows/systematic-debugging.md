---
description: 遇到任何 bug、测试失败或意外行为时使用，在提出修复方案之前
---

# 系统化调试

## 第一性原理

**为什么要系统化？** 随机尝试浪费时间并制造新 bug。症状修复掩盖根本问题。

**核心公理：**
1. 根因 > 症状 - 修症状只是推迟问题
2. 证据 > 猜测 - 数据说话，不是直觉
3. 一次一变量 - 多变量同时改动无法定位问题

## 铁律

```
没有根因调查，不要尝试修复
```

如果你没完成阶段 1，你没资格提出修复方案。

## 四个阶段

### 阶段 1：根因调查

**在尝试任何修复之前：**

1. **仔细阅读错误信息**
   - 不要跳过错误或警告
   - 完整阅读堆栈跟踪
   - 记录行号、文件路径、错误代码

2. **可靠复现**
   - 能稳定触发吗？
   - 确切步骤是什么？
   - 每次都发生吗？

3. **检查最近变更**
   - 什么变化可能导致这个？
   - git diff，最近提交
   - 新依赖、配置变更

4. **追踪数据流**
   - 坏数据从哪里来？
   - 谁用坏数据调用了这里？
   - 一直往上追，直到找到源头

### 阶段 2：模式分析

1. **找到工作示例**
   - 代码库中类似的工作代码
   - 什么能用，什么不能用？

2. **比较差异**
   - 工作版本和坏掉版本有什么不同？
   - 列出每个差异，不管多小

### 阶段 3：假设和测试

1. **形成单一假设**
   - 明确陈述："我认为 X 是根因，因为 Y"

2. **最小测试**
   - 做最小可能的改动来测试假设
   - 一次一个变量

3. **验证后继续**
   - 有效？→ 阶段 4
   - 无效？→ 形成新假设，不要叠加修复

### 阶段 4：实施

1. **创建失败测试用例**
   - 最简单的复现
   - 必须在修复前有

2. **实施单一修复**
   - 解决已识别的根因
   - 一次一个改动

3. **验证修复**
   - 测试现在通过了？
   - 其他测试没坏？

4. **如果 3+ 次修复失败**
   - 停止
   - 质疑架构
   - 与人类伙伴讨论后再继续

## 危险信号 - 停下来遵循流程

如果你发现自己在想：
- "先快速修复，之后再调查"
- "试着改 X 看看能不能用"
- "应该是 X，让我修一下"
- "我不完全理解但这可能有效"

**这些都意味着：停止。回到阶段 1。**

## 快速参考

| 阶段 | 关键活动 | 成功标准 |
|------|----------|----------|
| 1. 根因 | 读错误、复现、查变更 | 理解什么和为什么 |
| 2. 模式 | 找工作示例、比较 | 识别差异 |
| 3. 假设 | 形成理论、最小测试 | 确认或新假设 |
| 4. 实施 | 创建测试、修复、验证 | bug 解决，测试通过 |
