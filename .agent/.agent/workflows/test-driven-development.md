---
description: 实现任何功能或修复 bug 时使用，在写实现代码之前
---

# 测试驱动开发 (TDD)

## 第一性原理

**为什么先写测试？** 测试定义"正确"的含义。先有定义，才能验证实现。

**核心公理：**
1. 规格 > 实现 - 测试是可执行的规格
2. 看到失败才知道测试真的在测东西
3. 最小实现减少意外复杂度

## 铁律

```
没有失败的测试，不要写生产代码
```

先写了代码？删掉它。重新开始。

**没有例外：**
- 不要保留作为"参考"
- 不要在写测试时"调整"它
- 不要看它
- 删除就是删除

## 红-绿-重构循环

### 红 - 写失败测试

写一个最小测试，展示应该发生什么。

```typescript
test('失败操作重试 3 次', async () => {
  let attempts = 0;
  const operation = () => {
    attempts++;
    if (attempts < 3) throw new Error('fail');
    return 'success';
  };

  const result = await retryOperation(operation);

  expect(result).toBe('success');
  expect(attempts).toBe(3);
});
```

**要求：**
- 一个行为
- 清晰名称
- 真实代码（除非不可避免，否则不用 mock）

### 验证红 - 看它失败

**强制。绝不跳过。**

```bash
npm test path/to/test.test.ts
```

确认：
- 测试失败（不是报错）
- 失败原因是预期的
- 因为功能缺失而失败（不是拼写错误）

### 绿 - 最小代码

写最简单的代码让测试通过。

```typescript
async function retryOperation<T>(fn: () => Promise<T>): Promise<T> {
  for (let i = 0; i < 3; i++) {
    try {
      return await fn();
    } catch (e) {
      if (i === 2) throw e;
    }
  }
  throw new Error('unreachable');
}
```

不要添加功能、重构其他代码或"改进"超出测试范围。

### 验证绿 - 看它通过

```bash
npm test path/to/test.test.ts
```

确认：
- 测试通过
- 其他测试仍然通过
- 输出干净（无错误、警告）

### 重构 - 清理

只在绿色之后：
- 消除重复
- 改进命名
- 提取辅助函数

保持测试绿色。不要添加行为。

## 常见借口

| 借口 | 现实 |
|------|------|
| "太简单不用测" | 简单代码也会坏。测试只需 30 秒。 |
| "之后再测" | 立即通过的测试什么都不证明。 |
| "已经手动测过了" | 临时 ≠ 系统性。无记录，不能重跑。 |
| "删掉 X 小时的工作太浪费" | 沉没成本谬误。保留未验证代码是技术债。 |
| "TDD 太教条，我要务实" | TDD 就是务实：比调试更快。 |

## 危险信号 - 停下来重新开始

- 代码写在测试之前
- 测试写在实现之后
- 测试立即通过
- 无法解释测试为什么失败
- 计划"之后"添加测试
- 在说服自己"就这一次"

**这些都意味着：删除代码。用 TDD 重新开始。**

## 验证清单

标记工作完成前：

- [ ] 每个新函数/方法都有测试
- [ ] 在实现前看到每个测试失败
- [ ] 每个测试因预期原因失败（功能缺失，不是拼写错误）
- [ ] 用最小代码让每个测试通过
- [ ] 所有测试通过
- [ ] 输出干净（无错误、警告）
